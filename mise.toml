[tools]
"github:lucasew/mise-gettext-dagger" = "latest"
uv = "latest"

[tasks.install]
description = "Install dependencies"
run = "uv sync --extra dev"

[tasks."lint:ruff"]
description = "Lint code using ruff"
run = "uv run ruff check ."

[tasks."lint:format"]
description = "Check code formatting using ruff"
run = "uv run ruff format --check ."

[tasks."lint:mypy"]
description = "Lint code using mypy"
run = "uv run mypy --ignore-missing-imports ."

[tasks.lint]
description = "Run all linters"
depends = ["lint:*"]

[tasks."fmt:ruff"]
description = "Format code using ruff"
run = """
uv run ruff check --fix .
uv run ruff format .
"""

[tasks.fmt]
description = "Run all formatters"
depends = ["fmt:*"]

[tasks."codegen:locales"]
description = "Update locales"
run = "./update_locales"

[tasks.codegen]
description = "Run all codegen tasks"
depends = ["codegen:*"]

[tasks.test]
description = "Run tests"
run = "uv run pytest"

[tasks.ci]
description = "Run CI tasks (lint and test)"
depends = ["lint", "test"]

[tasks."ci-build:install-flatpak"]
description = "Install Flatpak and flatpak-builder"
run = """
sudo apt-get update
sudo apt-get install -y flatpak xvfb dbus-x11
flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
flatpak install --user -y flathub org.flatpak.Builder
"""

[tasks."ci-build:flatpak"]
description = "Build Flatpak package"
depends = ["ci-build:install-flatpak"]
run = """
# Start D-Bus session
eval $(dbus-launch --sh-syntax)
export DBUS_SESSION_BUS_ADDRESS

# Run flatpak-builder with xvfb and D-Bus (user installation)
xvfb-run -a flatpak run \
  --user org.flatpak.Builder \
  --user \
  --repo=repo \
  --force-clean \
  --install-deps-from=flathub \
  --keep-build-dirs \
  flatpak_app io.github.lucasew.ritm_annotation.yml

# Build bundle
flatpak build-bundle repo ritm_annotation.flatpak \
  io.github.lucasew.ritm_annotation

# Cleanup D-Bus
kill $DBUS_SESSION_BUS_PID 2>/dev/null || true
"""

[tasks."ci-build:docker"]
description = "Build Docker container"
env = { TAG = "ghcr.io/lucasew/ritm_annotation:latest" }
run = """
docker build -t "${TAG}" . -f Containerfile
"""

[tasks."ci-build:wheel"]
description = "Build Python wheel"
run = """
uvx cibuildwheel --output-dir dist
"""

[tasks."ci-build"]
description = "Run all CI build tasks"
depends = ["ci-build:*"]

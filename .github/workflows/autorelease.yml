name: Autorelease

on:
  push:
    branches: [main]
    tags: ['*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      new_version:
        description: 'New tag version'
        default: 'patch'
        type: choice
        options: [patch, minor, major]
  schedule:
  - cron: '0 2 * * 6'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  autorelease:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      packages: write
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - uses: jdx/mise-action@v2

    - name: Setup git config
      run: |
        git config user.name actions-bot
        git config user.email actions-bot@users.noreply.github.com

    - name: Install dependencies
      run: mise run install

    - name: Codegen
      run: mise run codegen

    - name: Check for changes and create PR
      if: github.event_name != 'pull_request' && github.event_name != 'workflow_dispatch'
      uses: peter-evans/create-pull-request@v7
      id: pr_create
      with:
        commit-message: Updater script changes
        branch: updater-bot
        delete-branch: true
        title: "Updater: stuff changed"
        body: "Changes caused from update scripts"

    - name: Check if should skip
      id: pr_check
      if: steps.pr_create.outputs.pull-request-number != ''
      run: |
        echo "Changes detected, PR created. Stopping here."
        echo "skip=true" >> $GITHUB_OUTPUT

    - name: Run CI
      if: steps.pr_check.outputs.skip != 'true'
      run: mise run ci

    - name: Bump Version
      id: version
      if: steps.pr_check.outputs.skip != 'true'
      env:
        NEW_VERSION: ${{ github.event.inputs.new_version }}
      run: |
        VERSION=""
        if [[ "${{ github.ref_type }}" == "tag" ]]; then
           VERSION="${{ github.ref_name }}"
        elif [[ ! -z "$NEW_VERSION" ]]; then
           NO_TAG=1 ./make_release "$NEW_VERSION"
           VERSION=$(cat ./ritm_annotation/VERSION)
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Free disk space
      if: steps.pr_check.outputs.skip != 'true'
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo docker system prune -af
        sudo apt-get clean

    - name: Build Artifacts
      if: steps.pr_check.outputs.skip != 'true'
      run: mise run ci-build

    - name: Login to Container Registry
      if: steps.version.outputs.version != ''
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ github.token }}

    - name: Publish Docker
      if: steps.version.outputs.version != ''
      env:
        TAG: ghcr.io/${{ github.repository }}
        RELEASE_VERSION: ${{ steps.version.outputs.version }}
      run: |
        docker push "${TAG}:latest"
        docker tag "${TAG}:latest" "${TAG}:${RELEASE_VERSION}"
        docker push "${TAG}:${RELEASE_VERSION}"

    - name: Create Release
      if: steps.version.outputs.version != ''
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TAG: ${{ steps.version.outputs.version }}
        TITLE: Release ${{ steps.version.outputs.version }}
      run: |
        gh release create "$TAG" \
          --title "$TITLE" \
          --generate-notes \
          --notes-start-tag $(gh release list --limit 1 --json tagName -q .[].tagName || echo "") \
          ritm_annotation.flatpak \
          dist/*.whl

    - name: Upload to PyPI
      if: steps.version.outputs.version != ''
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        uvx twine upload dist/*.whl

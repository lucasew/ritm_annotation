name: Autorelease

on:
  push:
    branches:
      - main
    tags:
      - '*'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      new_version:
        description: 'New tag version'
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
  schedule:
    - cron: '0 2 * * 6'   # saturday 2am

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install mise
        uses: jdx/mise-action@v3
        with:
          install: false

      - name: Trust mise config
        run: mise trust

      - name: Free disk space aggressively
        run: |
          echo "Before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/hostedtoolcache
          sudo docker system prune -af
          sudo apt-get clean
          echo "After cleanup:"
          df -h

      - name: Install tools
        run: mise install

      - name: Setup git config
        run: |
          git config user.name actions-bot
          git config user.email actions-bot@users.noreply.github.com

      - name: Install dependencies
        run: mise run install

      - name: Run Codegen
        run: mise run codegen

      - name: Create Pull Request if there is new stuff from updaters
        if: github.event_name != 'pull_request'
        uses: peter-evans/create-pull-request@v7
        id: pr_create
        with:
          commit-message: Updater script changes
          branch: updater-bot
          delete-branch: true
          title: "Updater: stuff changed"
          body: |
            Changes caused from update scripts

      - name: Check if PR created
        id: pr_check
        if: github.event_name != 'pull_request' && steps.pr_create.outputs.pull-request-number != ''
        run: |
          echo "The update scripts changed something and a PR was created. Stopping execution." >> $GITHUB_STEP_SUMMARY
          echo "skip=true" >> $GITHUB_OUTPUT

      - name: Run CI
        if: steps.pr_check.outputs.skip != 'true'
        run: mise run ci

      - name: Clean up dev environment
        if: steps.pr_check.outputs.skip != 'true'
        run: |
          rm -rf .venv
          uv cache clean
          # Also clean up any other temporary files
          rm -rf .pytest_cache
          rm -rf .mypy_cache
          rm -rf .ruff_cache

      - name: Bump Version
        if: github.event_name == 'workflow_dispatch' && steps.pr_check.outputs.skip != 'true'
        env:
          NEW_VERSION: ${{ github.event.inputs.new_version }}
        run: |
          if [[ ! -z "$NEW_VERSION" ]]; then
            # NO_TAG=1 because we want to tag in the Release step via gh release create
            NO_TAG=1 ./make_release "$NEW_VERSION"
            echo "BUMPED_VERSION=$(cat ./ritm_annotation/VERSION)" >> $GITHUB_ENV
          fi

      - name: Build Wheel
        if: steps.pr_check.outputs.skip != 'true'
        run: mise run ci-build:wheel

      - name: Login to Docker Registry
        if: steps.pr_check.outputs.skip != 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker
        if: steps.pr_check.outputs.skip != 'true'
        env:
          REGISTRY: ghcr.io
          IMAGE_NAME: ${{ github.repository }}
          VERSION: ${{ env.BUMPED_VERSION }}
        run: |
          mise run ci-build:docker

          # If we are releasing, tag and push
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && ! -z "$VERSION" ]]; then
            TAG="${REGISTRY}/${IMAGE_NAME}"
            docker tag "${TAG}:latest" "${TAG}:${VERSION}"
            docker push "${TAG}:latest"
            docker push "${TAG}:${VERSION}"
          fi

          # Clean up docker images to free space for Flatpak
          docker system prune -af

      - name: Build Flatpak
        if: steps.pr_check.outputs.skip != 'true'
        run: |
          # Ensure maximum free space before flatpak build
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/local/lib/node_modules
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/hostedtoolcache
          sudo rm -rf /usr/share/dotnet
          docker system prune -af

          mise run ci-build:flatpak

      - name: Publish Release
        if: github.event_name == 'workflow_dispatch' && steps.pr_check.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
          VERSION: ${{ env.BUMPED_VERSION }}
        run: |
          if [[ -z "$VERSION" ]]; then
            echo "No version bumped, skipping release."
            exit 0
          fi

          echo "Releasing version: $VERSION"

          # Create GitHub Release
          gh release create "$VERSION" \
            --title "Release $VERSION" \
            --generate-notes \
            --notes-start-tag $(gh release list --limit 1 --json tagName -q .[].tagName)

          # Upload artifacts to Release
          gh release upload "$VERSION" ritm_annotation.flatpak --clobber
          gh release upload "$VERSION" dist/*.whl --clobber

          # Publish to PyPI
          uvx twine upload dist/*.whl
